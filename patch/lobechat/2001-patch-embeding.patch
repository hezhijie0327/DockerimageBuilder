diff --git a/packages/database/src/models/chunk.ts b/packages/database/src/models/chunk.ts
index f5b0bb3..3ae431b 100644
--- a/packages/database/src/models/chunk.ts
+++ b/packages/database/src/models/chunk.ts
@@ -188,12 +188,13 @@ export class ChunkModel {
     query: string;
     topK?: number;
   }) => {
-    const similarity = sql<number>`1 - (${cosineDistance(embeddings.embeddings, embedding)})`;
-
     const hasFiles = fileIds && fileIds.length > 0;
 
     if (!hasFiles) return [];
 
+    // Construct the similarity expression properly
+    const similarity = sql<number>`1 - (embeddings.embeddings <=> ${embedding})`;
+
     const result = await this.db
       .select({
         fileId: files.id,
@@ -209,9 +210,14 @@ export class ChunkModel {
       .leftJoin(embeddings, eq(chunks.id, embeddings.chunkId))
       .leftJoin(fileChunks, eq(chunks.id, fileChunks.chunkId))
       .leftJoin(files, eq(files.id, fileChunks.fileId))
-      .where(inArray(fileChunks.fileId, fileIds))
+      .where(
+        and(
+          inArray(fileChunks.fileId, fileIds),
+          // Ensure we only get chunks with embeddings
+          sql`embeddings.embeddings IS NOT NULL`
+        )
+      )
       .orderBy((t) => desc(t.similarity))
-      // Relaxed to 15 for now
       .limit(topK);
 
     return result.map((item) => {
