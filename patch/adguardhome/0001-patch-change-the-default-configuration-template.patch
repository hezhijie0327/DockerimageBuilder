From 313ed84bfe4121bc97de4f1cacbb9259e040e917 Mon Sep 17 00:00:00 2001
From: Zhijie He <hezhijie0327@hotmail.com>
Date: Wed, 12 Oct 2022 22:38:39 +0800
Subject: [PATCH] Change the default configuration template

---
 internal/dhcpd/dhcpd.go           |  2 +-
 internal/dnsforward/dnsforward.go |  9 ++---
 internal/home/config.go           | 56 +++++++++++++------------------
 3 files changed, 29 insertions(+), 38 deletions(-)

diff --git a/internal/dhcpd/dhcpd.go b/internal/dhcpd/dhcpd.go
index 69082c0..93eff7f 100644
--- a/internal/dhcpd/dhcpd.go
+++ b/internal/dhcpd/dhcpd.go
@@ -16,7 +16,7 @@ import (

 const (
 	// DefaultDHCPLeaseTTL is the default time-to-live for leases.
-	DefaultDHCPLeaseTTL = uint32(timeutil.Day / time.Second)
+	DefaultDHCPLeaseTTL = uint32(timeutil.Day / 24 / time.Second)

 	// DefaultDHCPTimeoutICMP is the default timeout for waiting ICMP responses.
 	DefaultDHCPTimeoutICMP = 1000

diff --git a/internal/dnsforward/dnsforward.go b/internal/dnsforward/dnsforward.go
index 3806ef5b..bf1cd5dc 100644
--- a/internal/dnsforward/dnsforward.go
+++ b/internal/dnsforward/dnsforward.go
@@ -26,7 +26,7 @@ import (
 )

 // DefaultTimeout is the default upstream timeout
-const DefaultTimeout = 10 * time.Second
+const DefaultTimeout = 5 * time.Second

 // defaultClientIDCacheCount is the default count of items in the LRU ClientID
 // cache.  The assumption here is that there won't be more than this many
@@ -34,12 +34,13 @@ const DefaultTimeout = 10 * time.Second
 const defaultClientIDCacheCount = 1024

 var defaultDNS = []string{
-	"https://dns10.quad9.net/dns-query",
+	"https://dns.alidns.com:443/dns-query",
+	"tls://dns.alidns.com:853",
 }
-var defaultBootstrap = []string{"9.9.9.10", "149.112.112.10", "2620:fe::10", "2620:fe::fe:10"}
+var defaultBootstrap = []string{"tls://223.5.5.5:853", "tls://223.6.6.6:853", "tls://[2400:3200::1]:853", "tls://[2400:3200:baba::1]:853"}

 // Often requested by all kinds of DNS probes
-var defaultBlockedHosts = []string{"version.bind", "id.server", "hostname.bind"}
+var defaultBlockedHosts = []string{"|hostname.bind^", "|id.server^", "|version.bind^", "|version.server^"}

 var webRegistered bool

diff --git a/internal/home/config.go b/internal/home/config.go
index 2eb0aff..9785a1f 100644
--- a/internal/home/config.go
+++ b/internal/home/config.go
@@ -263,19 +263,19 @@ type statsConfig struct {
 var config = &configuration{
 	BindPort:           3000,
 	BindHost:           netip.IPv4Unspecified(),
-	AuthAttempts:       5,
-	AuthBlockMin:       15,
-	WebSessionTTLHours: 30 * 24,
+	AuthAttempts:       3,
+	AuthBlockMin:       60,
+	WebSessionTTLHours: 1,
 	DNS: dnsConfig{
 		BindHosts: []netip.Addr{netip.IPv4Unspecified()},
 		Port:      defaultPortDNS,
 		FilteringConfig: dnsforward.FilteringConfig{
 			ProtectionEnabled:  true, // whether or not use any of filtering features
 			BlockingMode:       dnsforward.BlockingModeDefault,
-			BlockedResponseTTL: 10, // in seconds
-			Ratelimit:          20,
+			BlockedResponseTTL: 3600, // in seconds
+			Ratelimit:          1000,
 			RefuseAny:          true,
-			AllServers:         false,
+			AllServers:         true,
 			HandleDDR:          true,
 			FastestTimeout: timeutil.Duration{
 				Duration: fastip.DefaultPingWaitTimeout,
@@ -286,7 +286,7 @@ var config = &configuration{

 			EDNSClientSubnet: &dnsforward.EDNSClientSubnet{
 				CustomIP:  netip.Addr{},
-				Enabled:   false,
+				Enabled:   true,
 				UseCustom: false,
 			},

@@ -294,19 +294,19 @@ var config = &configuration{
 			// we introduced a default limit due to this:
 			// https://github.com/AdguardTeam/AdGuardHome/issues/2015#issuecomment-674041912
 			// was later increased to 300 due to https://github.com/AdguardTeam/AdGuardHome/issues/2257
-			MaxGoroutines: 300,
+			MaxGoroutines: 1000,
 		},
 		DnsfilterConf: &filtering.Config{
-			FilteringEnabled:           true,
-			FiltersUpdateIntervalHours: 24,
+			FilteringEnabled:           false,
+			FiltersUpdateIntervalHours: 1,

 			ParentalEnabled:     false,
 			SafeBrowsingEnabled: false,

-			SafeBrowsingCacheSize: 1 * 1024 * 1024,
-			SafeSearchCacheSize:   1 * 1024 * 1024,
-			ParentalCacheSize:     1 * 1024 * 1024,
-			CacheTime:             30,
+			SafeBrowsingCacheSize: 4 * 1024 * 1024,
+			SafeSearchCacheSize:   4 * 1024 * 1024,
+			ParentalCacheSize:     4 * 1024 * 1024,
+			CacheTime:             3600,

 			SafeSearchConf: filtering.SafeSearchConfig{
 				Enabled:    false,
@@ -334,8 +334,8 @@ var config = &configuration{
 	QueryLog: queryLogConfig{
 		Enabled:     true,
 		FileEnabled: true,
-		Interval:    timeutil.Duration{Duration: 90 * timeutil.Day},
-		MemSize:     1000,
+		Interval:    timeutil.Duration{Duration: 7 * timeutil.Day},
+		MemSize:     0,
 		Ignored:     []string{},
 	},
 	Stats: statsConfig{
@@ -348,19 +348,9 @@ var config = &configuration{
 	//
 	// TODO(a.garipov): Think of a way to make scripts/vetted-filters update
 	// these as well if necessary.
-	Filters: []filtering.FilterYAML{{
-		Filter:  filtering.Filter{ID: 1},
-		Enabled: true,
-		URL:     "https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt",
-		Name:    "AdGuard DNS filter",
-	}, {
-		Filter:  filtering.Filter{ID: 2},
-		Enabled: false,
-		URL:     "https://adguardteam.github.io/HostlistsRegistry/assets/filter_2.txt",
-		Name:    "AdAway Default Blocklist",
-	}},
+	Filters: []filtering.FilterYAML{},
 	DHCP: &dhcpd.ServerConfig{
-		LocalDomainName: "lan",
+		LocalDomainName: "localdomain",
 		Conf4: dhcpd.V4ServerConf{
 			LeaseDuration: dhcpd.DefaultDHCPLeaseTTL,
 			ICMPTimeout:   dhcpd.DefaultDHCPTimeoutICMP,
@@ -379,11 +369,11 @@ var config = &configuration{
 		},
 	},
 	logSettings: logSettings{
-		Compress:   false,
-		LocalTime:  false,
-		MaxBackups: 0,
-		MaxSize:    100,
-		MaxAge:     3,
+		Compress:   true,
+		LocalTime:  true,
+		MaxBackups: 3,
+		MaxSize:    64,
+		MaxAge:     7,
 	},
 	OSConfig:      &osConfig{},
 	SchemaVersion: currentSchemaVersion,
--
2.41.0
